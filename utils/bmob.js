/*!
 * Bmob WeChat applet SDK
 * http://www.bmob.cn
 * Copyright Bmob, Inc.
 * The Bmob WeChat applet SDK is freely distributable under the MIT license.
 * (c) 2016-2050 Magic
 */(function(r){var e=require("underscore.js"),c={VERSION:"js0.0.1"};c._=e;var q=function(){};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports.Bmob=c):r.Bmob=c;var t=function(a,b,d){var f;f=b&&b.hasOwnProperty("constructor")?b.constructor:function(){a.apply(this,arguments)};c._.extend(f,a);q.prototype=a.prototype;f.prototype=new q;b&&c._.extend(f.prototype,b);d&&c._.extend(f,d);f.prototype.constructor=f;f.__super__=a.prototype;return f};c.serverURL="https://api.bmob.cn";c.fileURL="http://file.bmob.cn";"undefined"!==typeof process&&process.versions&&process.versions.node&&(c._isNode=!0);c.initialize=function(a,b,d){c._initialize(a,b,d)};c._initialize=function(a,b,d){c.applicationId=a;c.applicationKey=b;c.masterKey=d;c._useMasterKey=!0};c._isNode&&(c.initialize=c._initialize);c._getBmobPath=function(a){if(!c.applicationId)throw"You need to call Bmob.initialize before using Bmob.";a||(a="");if(!c._.isString(a))throw"Tried to get a localStorage path that wasn't a String.";"/"===a[0]&&(a=a.substring(1));return"Bmob/"+c.applicationId+"/"+a};c._getBmobPath=function(a){if(!c.applicationId)throw"You need to call Bmob.initialize before using Bmob.";a||(a="");if(!c._.isString(a))throw"Tried to get a localStorage path that wasn't a String.";"/"===a[0]&&(a=a.substring(1));return"Bmob/"+c.applicationId+"/"+a};c._installationId=null;c._getInstallationId=function(){if(c._installationId)return c._installationId;var a=c._getBmobPath("installationId");wx.getStorage({key:"key",success:function(a){c._installationId=a.data;console.log(a.data)}});if(!c._installationId||""===c._installationId){var b=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};c._installationId=b()+b()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b();wx.setStorage({key:a,data:c._installationId})}return c._installationId};c._parseDate=function(a){return(a=/^([0-9]{1,4})-([0-9]{1,2})-([0-9]{1,2})T([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})(.([0-9]+))?Z$/.exec(a))?new Date(Date.UTC(a[1]||0,(a[2]||1)-1,a[3]||0,a[4]||0,a[5]||0,a[6]||0,a[8]||0)):null};c._ajax=function(a,b,d,f,g){f={success:f,error:g};var e=new c.Promise,k=JSON.parse(d);wx.showNavigationBarLoading();"wechatApp"==k.category?wx.uploadFile({url:b,filePath:k.base64,name:"file",header:{"X-Bmob-SDK-Type":"wechatApp"},formData:k,success:function(a){console.log(a);var b=JSON.parse(a.data);e.resolve(b,a.statusCode,a);wx.hideNavigationBarLoading()},fail:function(a){console.log(a);e.reject(a);wx.hideNavigationBarLoading()}}):wx.request({method:a,url:b,data:d,header:{"content-type":"text/plain"},success:function(a){a.data&&a.data.code?e.reject(a):200!=a.statusCode?e.reject(a):e.resolve(a.data,a.statusCode,a);wx.hideNavigationBarLoading()},fail:function(a){e.reject(a);wx.hideNavigationBarLoading()}});return g?c.Promise.error(g):e._thenRunCallbacks(f)};c._extend=function(a,b){var c=t(this,a,b);c.extend=this.extend;return c};c._request=function(a,b,d,f,g){if(!c.applicationId)throw"You must specify your applicationId using Bmob.initialize";if(!c.applicationKey&&!c.masterKey)throw"You must specify a key using Bmob.initialize";var e=c.serverURL;"/"!==e.charAt(e.length-1)&&(e+="/");e=0>a.indexOf("2/")?e+("1/"+a):e+a;b&&(e+="/"+b);d&&(e+="/"+d);"users"!==a&&"classes"!==a||"PUT"!==f||!g._fetchWhenSave||(delete g._fetchWhenSave,e+="?new\x3dtrue");g=c._.clone(g||{});"POST"!==f&&(g._Method=f,f="POST");g._ApplicationId=c.applicationId;g._RestKey=c.applicationKey;c._useMasterKey&&void 0!=c.masterKey&&(g._MasterKey=c.masterKey);g._ClientVersion=c.VERSION;g._InstallationId=c._getInstallationId();(a=c.User.current())&&a._sessionToken&&(g._SessionToken=a._sessionToken);g=JSON.stringify(g);return c._ajax(f,e,g).then(null,function(a){var b;try{a.data.code&&(b=new c.Error(a.data.code,a.data.error))}catch(m){}b=b||new c.Error(-1,a.data);return c.Promise.error(b)})};c._getValue=function(a,b){return a&&a[b]?c._.isFunction(a[b])?a[b]():a[b]:null};c._encode=function(a,b,d){var f=c._;if(a instanceof c.Object){if(d)throw"Bmob.Objects not allowed here";if(!b||f.include(b,a)||!a._hasData)return a._toPointer();if(!a.dirty())return b=b.concat(a),c._encode(a._toFullJSON(b),b,d);throw"Tried to save an object with a pointer to a new, unsaved object.";}if(a instanceof c.ACL)return a.toJSON();if(f.isDate(a))return{__type:"Date",iso:a.toJSON()};if(a instanceof c.GeoPoint)return a.toJSON();if(f.isArray(a))return f.map(a,function(a){return c._encode(a,b,d)});if(f.isRegExp(a))return a.source;if(a instanceof c.Relation||a instanceof c.Op)return a.toJSON();if(a instanceof c.File){if(!a.url())throw"Tried to save an object containing an unsaved file.";return{__type:"File",cdn:a.cdn(),filename:a.name(),url:a.url()}}if(f.isObject(a)){var e={};c._objectEach(a,function(a,f){e[f]=c._encode(a,b,d)});return e}return a};c._decode=function(a,b){var d=c._;if(!d.isObject(b))return b;if(d.isArray(b))return c._arrayEach(b,function(a,d){b[d]=c._decode(d,a)}),b;if(b instanceof c.Object||b instanceof c.File||b instanceof c.Op)return b;if(b.__op)return c.Op._decode(b);if("Pointer"===b.__type)return d=b.className,d=c.Object._create(d),b.createdAt?(delete b.__type,delete b.className,d._finishFetch(b,!0)):d._finishFetch({objectId:b.objectId},!1),d;if("Object"===b.__type)return d=b.className,delete b.__type,delete b.className,d=c.Object._create(d),d._finishFetch(b,!0),d;if("Date"===b.__type)return b.iso;if("GeoPoint"===b.__type)return new c.GeoPoint({latitude:b.latitude,longitude:b.longitude});if("ACL"===a)return b instanceof c.ACL?b:new c.ACL(b);if("Relation"===b.__type)return d=new c.Relation(null,a),d.targetClassName=b.className,d;if("File"===b.__type)return void 0!=b.url&&null!=b.url?0<=b.url.indexOf("http")?{_name:b.filename,_url:b.url,_group:b.group}:{_name:b.filename,_url:c.fileURL+"/"+b.url,_group:b.group}:{_name:b.filename,_url:b.url,_group:b.group};c._objectEach(b,function(a,d){b[d]=c._decode(d,a)});return b};c._arrayEach=c._.each;c._traverse=function(a,b,d){if(a instanceof c.Object){d=d||[];if(0<=c._.indexOf(d,a))return;d.push(a);c._traverse(a.attributes,b,d);return b(a)}if(a instanceof c.Relation||a instanceof c.File)return b(a);if(c._.isArray(a))return c._.each(a,function(f,e){var g=c._traverse(f,b,d);g&&(a[e]=g)}),b(a);c._.isObject(a)&&c._each(a,function(f,e){var g=c._traverse(f,b,d);g&&(a[e]=g)});return b(a)};c._objectEach=c._each=function(a,b){var d=c._;d.isObject(a)?d.each(d.keys(a),function(c){b(a[c],c)}):d.each(a,b)};c._isNullOrUndefined=function(a){return c._.isNull(a)||c._.isUndefined(a)};c.Error=function(a,b){this.code=a;this.message=b};e.extend(c.Error,{OTHER_CAUSE:-1,OBJECT_NOT_FOUND:101,INVALID_QUERY:102,INVALID_CLASS_NAME:103,RELATIONDOCNOTEXISTS:104,INVALID_KEY_NAME:105,INVALID_POINTER:106,INVALID_JSON:107,USERNAME_PASSWORD_REQUIRED:108,INCORRECT_TYPE:111,REQUEST_MUST_ARRAY:112,REQUEST_MUST_OBJECT:113,OBJECT_TOO_LARGE:114,GEO_ERROR:117,EMAIL_VERIFY_MUST_OPEN:120,CACHE_MISS:120,INVALID_DEVICE_TOKEN:131,INVALID_INSTALLID:132,INVALID_DEVICE_TYPE:133,DEVICE_TOKEN_EXIST:134,INSTALLID_EXIST:135,DEVICE_TOKEN_NOT_FOR_ANDROID:136,INVALID_INSTALL_OPERATE:137,READ_ONLY:138,INVALID_ROLE_NAME:139,MISS_PUSH_DATA:141,INVALID_PUSH_TIME:142,INVALID_PUSH_EXPIRE:143,PUSH_TIME_MUST_BEFORE_NOW:144,FILE_SIZE_ERROR:145,FILE_NAME_ERROR:146,FILE_NAME_ERROR:147,FILE_LEN_ERROR:148,FILE_UPLOAD_ERROR:150,FILE_DELETE_ERROR:151,IMAGE_ERROR:160,IMAGE_MODE_ERROR:161,IMAGE_WIDTH_ERROR:162,IMAGE_HEIGHT_ERROR:163,IMAGE_LONGEDGE_ERROR:164,IMAGE_SHORTEDGE_ERROR:165,USER_MISSING:201,USER_NAME_TOKEN:202,EMAIL_EXIST:203,NO_EMAIL:204,NOT_FOUND_EMAIL:205,SESSIONTOKEN_ERROR:206,VALID_ERROR:301});c.Events={on:function(a,b,c){var d,e,h,k,l;if(!b)return this;a=a.split(n);d=this._callbacks||(this._callbacks={});for(e=a.shift();e;)h=(l=d[e])?l.tail:{},h.next=k={},h.context=c,h.callback=b,d[e]={tail:k,next:l?l.next:h},e=a.shift();return this},off:function(a,b,c){var d,g,h,k,l,m;if(g=this._callbacks){if(!(a||b||c))return delete this._callbacks,this;a=a?a.split(n):e.keys(g);for(d=a.shift();d;)if(h=g[d],delete g[d],h&&(b||c)){k=h.tail;for(h=h.next;h!==k;){l=h.callback;m=h.context;if(b&&l!==b||c&&m!==c)this.on(d,l,m);h=h.next}d=a.shift()}return this}},trigger:function(a){var b,c,f,e,h,k;if(!(f=this._callbacks))return this;h=f.all;a=a.split(n);k=slice.call(arguments,1);for(b=a.shift();b;){if(c=f[b])for(e=c.tail;(c=c.next)!==e;)c.callback.apply(c.context||this,k);if(c=h)for(e=c.tail,b=[b].concat(k);(c=c.next)!==e;)c.callback.apply(c.context||this,b);b=a.shift()}return this}};c.Events.bind=c.Events.on;c.Events.unbind=c.Events.off;c.GeoPoint=function(a,b){e.isArray(a)?(c.GeoPoint._validate(a[0],a[1]),this.latitude=a[0],this.longitude=a[1]):e.isObject(a)?(c.GeoPoint._validate(a.latitude,a.longitude),this.latitude=a.latitude,this.longitude=a.longitude):e.isNumber(a)&&e.isNumber(b)?(c.GeoPoint._validate(a,b),this.latitude=a,this.longitude=b):this.longitude=this.latitude=0;var d=this;this.__defineGetter__&&this.__defineSetter__&&(this._latitude=this.latitude,this._longitude=this.longitude,this.__defineGetter__("latitude",function(){return d._latitude}),this.__defineGetter__("longitude",function(){return d._longitude}),this.__defineSetter__("latitude",function(a){c.GeoPoint._validate(a,d.longitude);d._latitude=a}),this.__defineSetter__("longitude",function(a){c.GeoPoint._validate(d.latitude,a);d._longitude=a}))};c.GeoPoint._validate=function(a,b){if(-90>a)throw"Bmob.GeoPoint latitude "+a+" \x3c -90.0.";if(90<a)throw"Bmob.GeoPoint latitude "+a+" \x3e 90.0.";if(-180>b)throw"Bmob.GeoPoint longitude "+b+" \x3c -180.0.";if(180<b)throw"Bmob.GeoPoint longitude "+b+" \x3e 180.0.";};c.GeoPoint.current=function(a){var b=new c.Promise;navigator.geolocation.getCurrentPosition(function(a){b.resolve(new c.GeoPoint({latitude:a.coords.latitude,longitude:a.coords.longitude}))},function(a){b.reject(a)});return b._thenRunCallbacks(a)};c.GeoPoint.prototype={toJSON:function(){c.GeoPoint._validate(this.latitude,this.longitude);return{__type:"GeoPoint",latitude:this.latitude,longitude:this.longitude}},radiansTo:function(a){var b=Math.PI/180,c=this.latitude*b,f=a.latitude*b,e=Math.sin((c-f)/2);a=Math.sin((this.longitude*b-a.longitude*b)/2);c=e*e+Math.cos(c)*Math.cos(f)*a*a;c=Math.min(1,c);return 2*Math.asin(Math.sqrt(c))},kilometersTo:function(a){return 6371*this.radiansTo(a)},milesTo:function(a){return 3958.8*this.radiansTo(a)}};c.ACL=function(a){var b=this;b.permissionsById={};if(e.isObject(a))if(a instanceof c.User)b.setReadAccess(a,!0),b.setWriteAccess(a,!0);else{if(e.isFunction(a))throw"Bmob.ACL() called with a function.  Did you forget ()?";c._objectEach(a,function(a,f){if(!e.isString(f))throw"Tried to create an ACL with an invalid userId.";b.permissionsById[f]={};c._objectEach(a,function(a,c){if("read"!==c&&"write"!==c)throw"Tried to create an ACL with an invalid permission type.";if(!e.isBoolean(a))throw"Tried to create an ACL with an invalid permission value.";b.permissionsById[f][c]=a})})}};c.ACL.prototype.toJSON=function(){return e.clone(this.permissionsById)};c.ACL.prototype._setAccess=function(a,b,d){b instanceof c.User?b=b.id:b instanceof c.Role&&(b="role:"+b.getName());if(!e.isString(b))throw"userId must be a string.";if(!e.isBoolean(d))throw"allowed must be either true or false.";var f=this.permissionsById[b];if(!f)if(d)f={},this.permissionsById[b]=f;else return;d?this.permissionsById[b][a]=!0:(delete f[a],e.isEmpty(f)&&delete f[b])};c.ACL.prototype._getAccess=function(a,b){b instanceof c.User?b=b.id:b instanceof c.Role&&(b="role:"+b.getName());var d=this.permissionsById[b];return d?d[a]?!0:!1:!1};c.ACL.prototype.setReadAccess=function(a,b){this._setAccess("read",a,b)};c.ACL.prototype.getReadAccess=function(a){return this._getAccess("read",a)};c.ACL.prototype.setWriteAccess=function(a,b){this._setAccess("write",a,b)};c.ACL.prototype.getWriteAccess=function(a){return this._getAccess("write",a)};c.ACL.prototype.setPublicReadAccess=function(a){this.setReadAccess("*",a)};c.ACL.prototype.getPublicReadAccess=function(){return this.getReadAccess("*")};c.ACL.prototype.setPublicWriteAccess=function(a){this.setWriteAccess("*",a)};c.ACL.prototype.getPublicWriteAccess=function(){return this.getWriteAccess("*")};c.ACL.prototype.getRoleReadAccess=function(a){a instanceof c.Role&&(a=a.getName());if(e.isString(a))return this.getReadAccess("role:"+a);throw"role must be a Bmob.Role or a String";};c.ACL.prototype.getRoleWriteAccess=function(a){a instanceof c.Role&&(a=a.getName());if(e.isString(a))return this.getWriteAccess("role:"+a);throw"role must be a Bmob.Role or a String";};c.ACL.prototype.setRoleReadAccess=function(a,b){a instanceof c.Role&&(a=a.getName());if(e.isString(a))this.setReadAccess("role:"+a,b);else throw"role must be a Bmob.Role or a String";};c.ACL.prototype.setRoleWriteAccess=function(a,b){a instanceof c.Role&&(a=a.getName());if(e.isString(a))this.setWriteAccess("role:"+a,b);else throw"role must be a Bmob.Role or a String";};c.Op=function(){this._initialize.apply(this,arguments)};c.Op.prototype={_initialize:function(){}};e.extend(c.Op,{_extend:c._extend,_opDecoderMap:{},_registerDecoder:function(a,b){c.Op._opDecoderMap[a]=b},_decode:function(a){var b=c.Op._opDecoderMap[a.__op];if(b)return b(a)}});c.Op._registerDecoder("Batch",function(a){var b=null;c._arrayEach(a.ops,function(a){a=c.Op._decode(a);b=a._mergeWithPrevious(b)});return b});c.Op.Set=c.Op._extend({_initialize:function(a){this._value=a},value:function(){return this._value},toJSON:function(){return c._encode(this.value())},_mergeWithPrevious:function(a){return this},_estimate:function(a){return this.value()}});c.Op._UNSET={};c.Op.Unset=c.Op._extend({toJSON:function(){return{__op:"Delete"}},_mergeWithPrevious:function(a){return this},_estimate:function(a){return c.Op._UNSET}});c.Op._registerDecoder("Delete",function(a){return new c.Op.Unset});c.Op.Increment=c.Op._extend({_initialize:function(a){this._amount=a},amount:function(){return this._amount},toJSON:function(){return{__op:"Increment",amount:this._amount}},_mergeWithPrevious:function(a){if(a){if(a instanceof c.Op.Unset)return new c.Op.Set(this.amount());if(a instanceof c.Op.Set)return new c.Op.Set(a.value()+this.amount());if(a instanceof c.Op.Increment)return new c.Op.Increment(this.amount()+a.amount());throw"Op is invalid after previous op.";}return this},_estimate:function(a){return a?a+this.amount():this.amount()}});c.Op._registerDecoder("Increment",function(a){return new c.Op.Increment(a.amount)});c.Op.Add=c.Op._extend({_initialize:function(a){this._objects=a},objects:function(){return this._objects},toJSON:function(){return{__op:"Add",objects:c._encode(this.objects())}},_mergeWithPrevious:function(a){if(a){if(a instanceof c.Op.Unset)return new c.Op.Set(this.objects());if(a instanceof c.Op.Set)return new c.Op.Set(this._estimate(a.value()));if(a instanceof c.Op.Add)return new c.Op.Add(a.objects().concat(this.objects()));throw"Op is invalid after previous op.";}return this},_estimate:function(a){return a?a.concat(this.objects()):e.clone(this.objects())}});c.Op._registerDecoder("Add",function(a){return new c.Op.Add(c._decode(void 0,a.objects))});c.Op.AddUnique=c.Op._extend({_initialize:function(a){this._objects=e.uniq(a)},objects:function(){return this._objects},toJSON:function(){return{__op:"AddUnique",objects:c._encode(this.objects())}},_mergeWithPrevious:function(a){if(a){if(a instanceof c.Op.Unset)return new c.Op.Set(this.objects());if(a instanceof c.Op.Set)return new c.Op.Set(this._estimate(a.value()));if(a instanceof c.Op.AddUnique)return new c.Op.AddUnique(this._estimate(a.objects()));throw"Op is invalid after previous op.";}return this},_estimate:function(a){if(a){var b=e.clone(a);c._arrayEach(this.objects(),function(a){if(a instanceof c.Object&&a.id){var d=e.find(b,function(b){return b instanceof c.Object&&b.id===a.id});d?(d=e.indexOf(b,d),b[d]=a):b.push(a)}else e.contains(b,a)||b.push(a)});return b}return e.clone(this.objects())}});c.Op._registerDecoder("AddUnique",function(a){return new c.Op.AddUnique(c._decode(void 0,a.objects))});c.Op.Remove=c.Op._extend({_initialize:function(a){this._objects=e.uniq(a)},objects:function(){return this._objects},toJSON:function(){return{__op:"Remove",objects:c._encode(this.objects())}},_mergeWithPrevious:function(a){if(a){if(a instanceof c.Op.Unset)return a;if(a instanceof c.Op.Set)return new c.Op.Set(this._estimate(a.value()));if(a instanceof c.Op.Remove)return new c.Op.Remove(e.union(a.objects(),this.objects()));throw"Op is invalid after previous op.";}return this},_estimate:function(a){if(a){var b=e.difference(a,this.objects());c._arrayEach(this.objects(),function(a){a instanceof c.Object&&a.id&&(b=e.reject(b,function(b){return b instanceof c.Object&&b.id===a.id}))});return b}return[]}});c.Op._registerDecoder("Remove",function(a){return new c.Op.Remove(c._decode(void 0,a.objects))});c.Op.Relation=c.Op._extend({_initialize:function(a,b){this._targetClassName=null;var d=this,f=function(a){if(a instanceof c.Object){if(!a.id)throw"You can't add an unsaved Bmob.Object to a relation.";d._targetClassName||(d._targetClassName=a.className);if(d._targetClassName!==a.className)throw"Tried to create a Bmob.Relation with 2 different types: "+d._targetClassName+" and "+a.className+".";return a.id}return a};this.relationsToAdd=e.uniq(e.map(a,f));this.relationsToRemove=e.uniq(e.map(b,f))},added:function(){var a=this;return e.map(this.relationsToAdd,function(b){var d=c.Object._create(a._targetClassName);d.id=b;return d})},removed:function(){var a=this;return e.map(this.relationsToRemove,function(b){var d=c.Object._create(a._targetClassName);d.id=b;return d})},toJSON:function(){var a=null,b=null,c=this,f=function(a){return{__type:"Pointer",className:c._targetClassName,objectId:a}},g=null;0<this.relationsToAdd.length&&(g=e.map(this.relationsToAdd,f),a={__op:"AddRelation",objects:g});0<this.relationsToRemove.length&&(g=e.map(this.relationsToRemove,f),b={__op:"RemoveRelation",objects:g});return a&&b?{__op:"Batch",ops:[a,b]}:a||b||{}},_mergeWithPrevious:function(a){if(a){if(a instanceof c.Op.Unset)throw"You can't modify a relation after deleting it.";if(a instanceof c.Op.Relation){if(a._targetClassName&&a._targetClassName!==this._targetClassName)throw"Related object must be of class "+a._targetClassName+", but "+this._targetClassName+" was passed in.";var b=e.union(e.difference(a.relationsToAdd,this.relationsToRemove),this.relationsToAdd);a=e.union(e.difference(a.relationsToRemove,this.relationsToAdd),this.relationsToRemove);b=new c.Op.Relation(b,a);b._targetClassName=this._targetClassName;return b}throw"Op is invalid after previous op.";}return this},_estimate:function(a,b,d){if(a){if(a instanceof c.Relation){if(this._targetClassName)if(a.targetClassName){if(a.targetClassName!==this._targetClassName)throw"Related object must be a "+a.targetClassName+", but a "+this._targetClassName+" was passed in.";}else a.targetClassName=this._targetClassName;return a}throw"Op is invalid after previous op.";}(new c.Relation(b,d)).targetClassName=this._targetClassName}});c.Op._registerDecoder("AddRelation",function(a){return new c.Op.Relation(c._decode(void 0,a.objects),[])});c.Op._registerDecoder("RemoveRelation",function(a){return new c.Op.Relation([],c._decode(void 0,a.objects))});c.Relation=function(a,b){this.parent=a;this.key=b;this.targetClassName=null};c.Relation.reverseQuery=function(a,b,d){a=new c.Query(a);a.equalTo(b,d._toPointer());return a};c.Relation.prototype={_ensureParentAndKey:function(a,b){this.parent=this.parent||a;this.key=this.key||b;if(this.parent!==a)throw"Internal Error. Relation retrieved from two different Objects.";if(this.key!==b)throw"Internal Error. Relation retrieved from two different keys.";},add:function(a){e.isArray(a)||(a=[a]);a=new c.Op.Relation(a,[]);this.parent.set(this.key,a);this.targetClassName=a._targetClassName},remove:function(a){e.isArray(a)||(a=[a]);a=new c.Op.Relation([],a);this.parent.set(this.key,a);this.targetClassName=a._targetClassName},toJSON:function(){return{__type:"Relation",className:this.targetClassName}},query:function(){var a;this.targetClassName?(a=c.Object._getSubclass(this.targetClassName),a=new c.Query(a)):(a=c.Object._getSubclass(this.parent.className),a=new c.Query(a),a._extraOptions.redirectClassNameForKey=this.key);a._addCondition("$relatedTo","object",this.parent._toPointer());a._addCondition("$relatedTo","key",this.key);return a}};c.Promise=function(){this._rejected=this._resolved=!1;this._resolvedCallbacks=[];this._rejectedCallbacks=[]};e.extend(c.Promise,{is:function(a){return a&&a.then&&e.isFunction(a.then)},as:function(){var a=new c.Promise;a.resolve.apply(a,arguments);return a},error:function(){var a=new c.Promise;a.reject.apply(a,arguments);return a},when:function(a){var b;b=a&&c._isNullOrUndefined(a.length)?arguments:a;var d=b.length,f=!1,e=[],h=[];e.length=b.length;h.length=b.length;if(0===d)return c.Promise.as.apply(this,e);var k=new c.Promise,l=function(){--d;0===d&&(f?k.reject(h):k.resolve.apply(k,e))};c._arrayEach(b,function(a,b){c.Promise.is(a)?a.then(function(a){e[b]=a;l()},function(a){h[b]=a;f=!0;l()}):(e[b]=a,l())});return k},_continueWhile:function(a,b){return a()?b().then(function(){return c.Promise._continueWhile(a,b)}):c.Promise.as()}});e.extend(c.Promise.prototype,{resolve:function(a){if(this._resolved||this._rejected)throw"A promise was resolved even though it had already been "+(this._resolved?"resolved":"rejected")+".";this._resolved=!0;var b=this._result=arguments;c._arrayEach(this._resolvedCallbacks,function(a){a.apply(this,b)});this._resolvedCallbacks=[];this._rejectedCallbacks=[]},reject:function(a){if(this._resolved||this._rejected)throw"A promise was rejected even though it had already been "+(this._resolved?"resolved":"rejected")+".";this._rejected=!0;this._error=a;c._arrayEach(this._rejectedCallbacks,function(b){b(a)});this._resolvedCallbacks=[];this._rejectedCallbacks=[]},then:function(a,b){var d=new c.Promise,f=function(){var b=arguments;a&&(b=[a.apply(this,b)]);1===b.length&&c.Promise.is(b[0])?b[0].then(function(){d.resolve.apply(d,arguments)},function(a){d.reject(a)}):d.resolve.apply(d,b)},e=function(a){var f=[];b?(f=[b(a)],1===f.length&&c.Promise.is(f[0])?f[0].then(function(){d.resolve.apply(d,arguments)},function(a){d.reject(a)}):d.reject(f[0])):d.reject(a)};this._resolved?f.apply(this,this._result):this._rejected?e(this._error):(this._resolvedCallbacks.push(f),this._rejectedCallbacks.push(e));return d},_thenRunCallbacks:function(a,b){var d;d=(d=e.isFunction(a)?{success:function(b){a(b,null)},error:function(b){a(null,b)}}:e.clone(a))||{};return this.then(function(a){d.success?d.success.apply(this,arguments):b&&b.trigger("sync",b,a,d);return c.Promise.as.apply(c.Promise,arguments)},function(a){d.error?e.isUndefined(b)?d.error(a):d.error(b,a):b&&b.trigger("error",b,a,d);return c.Promise.error(a)})},_continueWith:function(a){return this.then(function(){return a(arguments,null)},function(b){return a(null,b)})}});var u={ai:"application/postscript",aif:"audio/x-aiff",aifc:"audio/x-aiff",aiff:"audio/x-aiff",asc:"text/plain",atom:"application/atom+xml",au:"audio/basic",avi:"video/x-msvideo",bcpio:"application/x-bcpio",bin:"application/octet-stream",bmp:"image/bmp",cdf:"application/x-netcdf",cgm:"image/cgm","class":"application/octet-stream",cpio:"application/x-cpio",cpt:"application/mac-compactpro",csh:"application/x-csh",css:"text/css",dcr:"application/x-director",dif:"video/x-dv",dir:"application/x-director",djv:"image/vnd.djvu",djvu:"image/vnd.djvu",dll:"application/octet-stream",dmg:"application/octet-stream",dms:"application/octet-stream",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",dotx:"application/vnd.openxmlformats-officedocument.wordprocessingml.template",docm:"application/vnd.ms-word.document.macroEnabled.12",dotm:"application/vnd.ms-word.template.macroEnabled.12",dtd:"application/xml-dtd",dv:"video/x-dv",dvi:"application/x-dvi",dxr:"application/x-director",eps:"application/postscript",etx:"text/x-setext",exe:"application/octet-stream",ez:"application/andrew-inset",gif:"image/gif",gram:"application/srgs",grxml:"application/srgs+xml",gtar:"application/x-gtar",hdf:"application/x-hdf",hqx:"application/mac-binhex40",htm:"text/html",html:"text/html",ice:"x-conference/x-cooltalk",ico:"image/x-icon",ics:"text/calendar",ief:"image/ief",ifb:"text/calendar",iges:"model/iges",igs:"model/iges",jnlp:"application/x-java-jnlp-file",jp2:"image/jp2",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/x-javascript",kar:"audio/midi",latex:"application/x-latex",lha:"application/octet-stream",lzh:"application/octet-stream",m3u:"audio/x-mpegurl",m4a:"audio/mp4a-latm",m4b:"audio/mp4a-latm",m4p:"audio/mp4a-latm",m4u:"video/vnd.mpegurl",m4v:"video/x-m4v",mac:"image/x-macpaint",man:"application/x-troff-man",mathml:"application/mathml+xml",me:"application/x-troff-me",mesh:"model/mesh",mid:"audio/midi",midi:"audio/midi",mif:"application/vnd.mif",mov:"video/quicktime",movie:"video/x-sgi-movie",mp2:"audio/mpeg",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",ms:"application/x-troff-ms",msh:"model/mesh",mxu:"video/vnd.mpegurl",nc:"application/x-netcdf",oda:"application/oda",ogg:"application/ogg",pbm:"image/x-portable-bitmap",pct:"image/pict",pdb:"chemical/x-pdb",pdf:"application/pdf",pgm:"image/x-portable-graymap",pgn:"application/x-chess-pgn",pic:"image/pict",pict:"image/pict",png:"image/png",pnm:"image/x-portable-anymap",pnt:"image/x-macpaint",pntg:"image/x-macpaint",ppm:"image/x-portable-pixmap",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",potx:"application/vnd.openxmlformats-officedocument.presentationml.template",ppsx:"application/vnd.openxmlformats-officedocument.presentationml.slideshow",ppam:"application/vnd.ms-powerpoint.addin.macroEnabled.12",pptm:"application/vnd.ms-powerpoint.presentation.macroEnabled.12",potm:"application/vnd.ms-powerpoint.template.macroEnabled.12",ppsm:"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",ps:"application/postscript",qt:"video/quicktime",qti:"image/x-quicktime",qtif:"image/x-quicktime",ra:"audio/x-pn-realaudio",ram:"audio/x-pn-realaudio",ras:"image/x-cmu-raster",rdf:"application/rdf+xml",rgb:"image/x-rgb",rm:"application/vnd.rn-realmedia",roff:"application/x-troff",rtf:"text/rtf",rtx:"text/richtext",sgm:"text/sgml",sgml:"text/sgml",sh:"application/x-sh",shar:"application/x-shar",silo:"model/mesh",sit:"application/x-stuffit",skd:"application/x-koan",skm:"application/x-koan",skp:"application/x-koan",skt:"application/x-koan",smi:"application/smil",smil:"application/smil",snd:"audio/basic",so:"application/octet-stream",spl:"application/x-futuresplash",src:"application/x-wais-source",sv4cpio:"application/x-sv4cpio",sv4crc:"application/x-sv4crc",svg:"image/svg+xml",swf:"application/x-shockwave-flash",t:"application/x-troff",tar:"application/x-tar",tcl:"application/x-tcl",tex:"application/x-tex",texi:"application/x-texinfo",texinfo:"application/x-texinfo",tif:"image/tiff",tiff:"image/tiff",tr:"application/x-troff",tsv:"text/tab-separated-values",txt:"text/plain",ustar:"application/x-ustar",vcd:"application/x-cdlink",vrml:"model/vrml",vxml:"application/voicexml+xml",wav:"audio/x-wav",wbmp:"image/vnd.wap.wbmp",wbmxl:"application/vnd.wap.wbxml",wml:"text/vnd.wap.wml",wmlc:"application/vnd.wap.wmlc",wmls:"text/vnd.wap.wmlscript",wmlsc:"application/vnd.wap.wmlscriptc",wrl:"model/vrml",xbm:"image/x-xbitmap",xht:"application/xhtml+xml",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xltx:"application/vnd.openxmlformats-officedocument.spreadsheetml.template",xlsm:"application/vnd.ms-excel.sheet.macroEnabled.12",xltm:"application/vnd.ms-excel.template.macroEnabled.12",xlam:"application/vnd.ms-excel.addin.macroEnabled.12",xlsb:"application/vnd.ms-excel.sheet.binary.macroEnabled.12",xslt:"application/xslt+xml",xul:"application/vnd.mozilla.xul+xml",xwd:"image/x-xwindowdump",xyz:"chemical/x-xyz",zip:"application/zip"},v=function(a,b){var d=new c.Promise;if("undefined"===typeof FileReader)return c.Promise.error(new c.Error(-1,"Attempted to use a FileReader on an unsupported browser."));var f=new FileReader;f.onloadend=function(){d.resolve(f.result)};f.readAsBinaryString(a);return d};c.File=function(a,b,d){b=b[0];this._name=a;var f=c.User.current();this._metaData={owner:null!=f?f.id:"unknown"};(a=/\.([^.]*)$/.exec(a))&&(a=a[1].toLowerCase());this._guessedType=a=d||u[a]||"text/plain";"undefined"!==typeof File&&b instanceof File?this._source=v(b,d):(this._source=c.Promise.as(b,a),this._metaData.size=b.length)};c.File.prototype={name:function(){return this._name},setName:function(a){this._name=a},url:function(){return this._url},setUrl:function(a){this._url=a},cdn:function(){return this._cdn},metaData:function(a,b){return null!=a&&null!=b?(this._metaData[a]=b,this):null!=a?this._metaData[a]:this._metaData},destroy:function(a){return this._url||this._cdn?c._request("2/files",null,null,"DELETE",{cdn:this._cdn,_ContentType:"application/json",url:this._url,metaData:self._metaData})._thenRunCallbacks(a):c.Promise.error("The file url and cdn is not eixsts.")._thenRunCallbacks(a)},save:function(a){var b=this;if(!b._previousSave)if(b._source)b._previousSave=b._source.then(function(a,f){var d={base64:a,_ContentType:"text/plain",mime_type:"text/plain",metaData:b._metaData,category:"wechatApp"};b._metaData.size||(b._metaData.size=a.length);return c._request("2/files",b._name,null,"POST",d)}).then(function(a){b._name=a.filename;b._url=a.url;b._cdn=a.cdn;return b});else throw"not source file";return b._previousSave._thenRunCallbacks(a)}};c.Files=c.Files||{};c.Files.del=function(a,b){var d=a.split(".com");return d?c._request("2/files/upyun",d[1],null,"DELETE",{_ContentType:"application/json"}).then(function(a){return c._decode(null,a)})._thenRunCallbacks(b):c.Promise.error("The file url and cdn is not eixsts.")._thenRunCallbacks(b)};c.Object=function(a,b){if(e.isString(a))return c.Object._create.apply(this,arguments);a=a||{};b&&b.parse&&(a=this.parse(a));var d=c._getValue(this,"defaults");d&&(a=e.extend({},d,a));b&&b.collection&&(this.collection=b.collection);this._serverData={};this._opSetQueue=[{}];this.attributes={};this._hashedJSON={};this._escapedAttributes={};this.cid=e.uniqueId("c");this.changed={};this._silent={};this._pending={};if(!this.set(a,{silent:!0}))throw Error("Can't create an invalid Bmob.Object");this.changed={};this._silent={};this._pending={};this._hasData=!0;this._previousAttributes=e.clone(this.attributes);this.initialize.apply(this,arguments)};c.Object.saveAll=function(a,b){return c.Object._deepSaveAsync(a)._thenRunCallbacks(b)};e.extend(c.Object.prototype,c.Events,{_existed:!1,_fetchWhenSave:!1,initialize:function(){},fetchWhenSave:function(a){if("boolean"!==typeof a)throw"Expect boolean value for fetchWhenSave";this._fetchWhenSave=a},toJSON:function(){var a=this._toFullJSON();c._arrayEach(["__type","className"],function(b){delete a[b]});return a},_toFullJSON:function(a){var b=e.clone(this.attributes);c._objectEach(b,function(d,f){b[f]=c._encode(d,a)});c._objectEach(this._operations,function(a,c){b[c]=a});e.has(this,"id")&&(b.objectId=this.id);e.has(this,"createdAt")&&(e.isDate(this.createdAt)?b.createdAt=this.createdAt.toJSON():b.createdAt=this.createdAt);e.has(this,"updatedAt")&&(e.isDate(this.updatedAt)?b.updatedAt=this.updatedAt.toJSON():b.updatedAt=this.updatedAt);b.__type="Object";b.className=this.className;return b},_refreshCache:function(){var a=this;a._refreshingCache||(a._refreshingCache=!0,c._objectEach(this.attributes,function(b,d){b instanceof c.Object?b._refreshCache():e.isObject(b)&&a._resetCacheForKey(d)&&a.set(d,new c.Op.Set(b),{silent:!0})}),delete a._refreshingCache)},dirty:function(a){this._refreshCache();var b=e.last(this._opSetQueue);return a?b[a]?!0:!1:!this.id||0<e.keys(b).length?!0:!1},_toPointer:function(){return{__type:"Pointer",className:this.className,objectId:this.id}},get:function(a){return this.attributes[a]},relation:function(a){var b=this.get(a);if(b){if(!(b instanceof c.Relation))throw"Called relation() on non-relation field "+a;b._ensureParentAndKey(this,a);return b}return new c.Relation(this,a)},escape:function(a){var b=this._escapedAttributes[a];if(b)return b;b=this.attributes[a];b=c._isNullOrUndefined(b)?"":e.escape(b.toString());return this._escapedAttributes[a]=b},has:function(a){return!c._isNullOrUndefined(this.attributes[a])},_mergeMagicFields:function(a){var b=this;c._arrayEach(["id","objectId","createdAt","updatedAt"],function(c){a[c]&&("objectId"===c?b.id=a[c]:b[c]=a[c],delete a[c])})},_startSave:function(){this._opSetQueue.push({})},_cancelSave:function(){var a=e.first(this._opSetQueue);this._opSetQueue=e.rest(this._opSetQueue);var b=e.first(this._opSetQueue);c._objectEach(a,function(c,f){var d=a[f],e=b[f];d&&e?b[f]=e._mergeWithPrevious(d):d&&(b[f]=d)});--this._saving},_finishSave:function(a){var b={};c._traverse(this.attributes,function(a){a instanceof c.Object&&a.id&&a._hasData&&(b[a.id]=a)});var d=e.first(this._opSetQueue);this._opSetQueue=e.rest(this._opSetQueue);this._applyOpSet(d,this._serverData);this._mergeMagicFields(a);var f=this;c._objectEach(a,function(a,d){f._serverData[d]=c._decode(d,a);var e=c._traverse(f._serverData[d],function(a){if(a instanceof c.Object&&b[a.id])return b[a.id]});e&&(f._serverData[d]=e)});this._rebuildAllEstimatedData();--this._saving},_finishFetch:function(a,b){this._opSetQueue=[{}];this._mergeMagicFields(a);var d=this;c._objectEach(a,function(a,b){d._serverData[b]=c._decode(b,a)});this._rebuildAllEstimatedData();this._refreshCache();this._opSetQueue=[{}];this._hasData=b},_applyOpSet:function(a,b){var d=this;c._objectEach(a,function(a,e){b[e]=a._estimate(b[e],d,e);b[e]===c.Op._UNSET&&delete b[e]})},_resetCacheForKey:function(a){var b=this.attributes[a];return!e.isObject(b)||b instanceof c.Object||b instanceof c.File||(b=b.toJSON?b.toJSON():b,b=JSON.stringify(b),this._hashedJSON[a]===b)?!1:(this._hashedJSON[a]=b,!0)},_rebuildEstimatedDataForKey:function(a){var b=this;delete this.attributes[a];this._serverData[a]&&(this.attributes[a]=this._serverData[a]);c._arrayEach(this._opSetQueue,function(d){if(d=d[a])b.attributes[a]=d._estimate(b.attributes[a],b,a),b.attributes[a]===c.Op._UNSET?delete b.attributes[a]:b._resetCacheForKey(a)})},_rebuildAllEstimatedData:function(){var a=this,b=e.clone(this.attributes);this.attributes=e.clone(this._serverData);c._arrayEach(this._opSetQueue,function(b){a._applyOpSet(b,a.attributes);c._objectEach(b,function(b,c){a._resetCacheForKey(c)})});c._objectEach(b,function(b,c){a.attributes[c]!==b&&a.trigger("change:"+c,a,a.attributes[c],{})});c._objectEach(this.attributes,function(c,f){e.has(b,f)||a.trigger("change:"+f,a,c,{})})},set:function(a,b,d){var f;e.isObject(a)||c._isNullOrUndefined(a)?(f=a,c._objectEach(f,function(a,b){f[b]=c._decode(b,a)}),d=b):(f={},f[a]=c._decode(a,b));d=d||{};if(!f)return this;f instanceof c.Object&&(f=f.attributes);d.unset&&c._objectEach(f,function(a,b){f[b]=new c.Op.Unset});var g=e.clone(f),h=this;c._objectEach(g,function(a,b){a instanceof c.Op&&(g[b]=a._estimate(h.attributes[b],h,b),g[b]===c.Op._UNSET&&delete g[b])});if(!this._validate(f,d))return!1;this._mergeMagicFields(f);d.changes={};var k=this._escapedAttributes;c._arrayEach(e.keys(f),function(a){var b=f[a];b instanceof c.Relation&&(b.parent=h);b instanceof c.Op||(b=new c.Op.Set(b));var g=!0;b instanceof c.Op.Set&&e.isEqual(h.attributes[a],b.value)&&(g=!1);g&&(delete k[a],d.silent?h._silent[a]=!0:d.changes[a]=!0);var l=e.last(h._opSetQueue);l[a]=b._mergeWithPrevious(l[a]);h._rebuildEstimatedDataForKey(a);g?(h.changed[a]=h.attributes[a],d.silent||(h._pending[a]=!0)):(delete h.changed[a],delete h._pending[a])});d.silent||this.change(d);return this},unset:function(a,b){b=b||{};b.unset=!0;return this.set(a,null,b)},increment:function(a,b){if(e.isUndefined(b)||e.isNull(b))b=1;return this.set(a,new c.Op.Increment(b))},add:function(a,b){return this.set(a,new c.Op.Add([b]))},addUnique:function(a,b){return this.set(a,new c.Op.AddUnique([b]))},remove:function(a,b){return this.set(a,new c.Op.Remove([b]))},op:function(a){return e.last(this._opSetQueue)[a]},clear:function(a){a=a||{};a.unset=!0;var b=e.extend(this.attributes,this._operations);return this.set(b,a)},_getSaveJSON:function(){var a=e.clone(e.first(this._opSetQueue));c._objectEach(a,function(b,c){a[c]=b.toJSON()});return a},_canBeSerialized:function(){return c.Object._canBeSerializedAsValue(this.attributes)},fetch:function(a){var b=this;return c._request("classes",this.className,this.id,"GET").then(function(a,c,e){b._finishFetch(b.parse(a,c,e),!0);return b})._thenRunCallbacks(a,this)},save:function(a,b,d){var f,g,h;e.isObject(a)||c._isNullOrUndefined(a)?(f=a,h=b):(f={},f[a]=b,h=d);if(!h&&f&&0===e.reject(f,function(a,b){return e.include(["success","error","wait"],b)}).length&&(a=!0,e.has(f,"success")&&!e.isFunction(f.success)&&(a=!1),e.has(f,"error")&&!e.isFunction(f.error)&&(a=!1),a))return this.save(null,f);h=e.clone(h)||{};h.wait&&(g=e.clone(this.attributes));var k=e.clone(h)||{};k.wait&&(k.silent=!0);var l;k.error=function(a,b){l=b};if(f&&!this.set(f,k))return c.Promise.error(l)._thenRunCallbacks(h,this);var m=this;m._refreshCache();a=[];b=[];c.Object._findUnsavedChildren(m.attributes,a,b);if(0<a.length+b.length)return c.Object._deepSaveAsync(this.attributes).then(function(){return m.save(null,h)},function(a){return c.Promise.error(a)._thenRunCallbacks(h,m)});this._startSave();this._saving=(this._saving||0)+1;this._allPreviousSaves=this._allPreviousSaves||c.Promise.as();return this._allPreviousSaves=this._allPreviousSaves._continueWith(function(){var a=m.id?"PUT":"POST",b=m._getSaveJSON();"PUT"===a&&m._fetchWhenSave&&(b._fetchWhenSave=!0);var d="classes",l=m.className;"_User"!==m.className||m.id||(d="users",l=null);a=c._request(d,l,m.id,a,b);return a=a.then(function(a,b,c){a=m.parse(a,b,c);h.wait&&(a=e.extend(f||{},a));m._finishSave(a);h.wait&&m.set(g,k);return m},function(a){m._cancelSave();return c.Promise.error(a)})._thenRunCallbacks(h,m)})},destroy:function(a){a=a||{};var b=this,d=function(){b.trigger("destroy",b,b.collection,a)};if(!this.id)return d();a.wait||d();return c._request("classes",this.className,this.id,"DELETE").then(function(){a.wait&&d();return b})._thenRunCallbacks(a,this)},parse:function(a,b,c){var d=e.clone(a);e(["createdAt","updatedAt"]).each(function(a){d[a]&&(d[a]=d[a])});d.updatedAt||(d.updatedAt=d.createdAt);b&&(this._existed=201!==b);return d},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.id},change:function(a){a=a||{};var b=this._changing;this._changing=!0;var d=this;c._objectEach(this._silent,function(a){d._pending[a]=!0});var f=e.extend({},a.changes,this._silent);this._silent={};c._objectEach(f,function(b,c){d.trigger("change:"+c,d,d.get(c),a)});if(b)return this;for(b=function(a,b){d._pending[b]||d._silent[b]||delete d.changed[b]};!e.isEmpty(this._pending);)this._pending={},this.trigger("change",this,a),c._objectEach(this.changed,b),d._previousAttributes=e.clone(this.attributes);this._changing=!1;return this},existed:function(){return this._existed},hasChanged:function(a){return arguments.length?this.changed&&e.has(this.changed,a):!e.isEmpty(this.changed)},changedAttributes:function(a){if(!a)return this.hasChanged()?e.clone(this.changed):!1;var b={},d=this._previousAttributes;c._objectEach(a,function(a,c){e.isEqual(d[c],a)||(b[c]=a)});return b},previous:function(a){return arguments.length&&this._previousAttributes?this._previousAttributes[a]:null},previousAttributes:function(){return e.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},validate:function(a,b){return!e.has(a,"ACL")||a.ACL instanceof c.ACL?!1:new c.Error(c.Error.OTHER_CAUSE,"ACL must be a Bmob.ACL.")},_validate:function(a,b){if(b.silent||!this.validate)return!0;a=e.extend({},this.attributes,a);var c=this.validate(a,b);if(!c)return!0;b&&b.error?b.error(this,c,b):this.trigger("error",this,c,b);return!1},getACL:function(){return this.get("ACL")},setACL:function(a,b){return this.set("ACL",a,b)}});c.Object.createWithoutData=function(a,b,d){a=new c.Object(a);a.id=b;a._hasData=d;return a};c.Object.destroyAll=function(a,b){if(null==a||0==a.length)return c.Promise.as()._thenRunCallbacks(b);var d=a[0].className,e="",g=!0;a.forEach(function(a){if(a.className!=d)throw"Bmob.Object.destroyAll requires the argument object array's classNames must be the same";if(!a.id)throw"Could not delete unsaved object";g?(e=a.id,g=!1):e=e+","+a.id});return c._request("classes",d,e,"DELETE")._thenRunCallbacks(b)};c.Object._getSubclass=function(a){if(!e.isString(a))throw"Bmob.Object._getSubclass requires a string argument.";var b=c.Object._classMap[a];b||(b=c.Object.extend(a),c.Object._classMap[a]=b);return b};c.Object._create=function(a,b,d){return new (c.Object._getSubclass(a))(b,d)};c.Object._classMap={};c.Object._extend=c._extend;c.Object.extend=function(a,b,d){if(!e.isString(a)){if(a&&e.has(a,"className"))return c.Object.extend(a.className,a,b);throw Error("Bmob.Object.extend's first argument should be the className.");}"User"===a&&(a="_User");var f=null;e.has(c.Object._classMap,a)?f=c.Object._classMap[a]._extend(b,d):(b=b||{},b.className=a,f=this._extend(b,d));f.extend=function(b){if(e.isString(b)||b&&e.has(b,"className"))return c.Object.extend.apply(f,arguments);var d=[a].concat(c._.toArray(arguments));return c.Object.extend.apply(f,d)};return c.Object._classMap[a]=f};c.Object._findUnsavedChildren=function(a,b,d){c._traverse(a,function(a){a instanceof c.Object?(a._refreshCache(),a.dirty()&&b.push(a)):a instanceof c.File&&(a.url()||d.push(a))})};c.Object._canBeSerializedAsValue=function(a){var b=!0;a instanceof c.Object?b=!!a.id:e.isArray(a)?c._arrayEach(a,function(a){c.Object._canBeSerializedAsValue(a)||(b=!1)}):e.isObject(a)&&c._objectEach(a,function(a){c.Object._canBeSerializedAsValue(a)||(b=!1)});return b};c.Object._deepSaveAsync=function(a){var b=[],d=[];c.Object._findUnsavedChildren(a,b,d);var f=c.Promise.as();e.each(d,function(a){f=f.then(function(){return a.save()})});var b=e.uniq(b),g=e.uniq(b);return f.then(function(){return c.Promise._continueWhile(function(){return 0<g.length},function(){var a=[],b=[];c._arrayEach(g,function(c){20<a.length?b.push(c):c._canBeSerialized()?a.push(c):b.push(c)});g=b;if(0===a.length)return c.Promise.error(new c.Error(c.Error.OTHER_CAUSE,"Tried to save a batch with a cycle."));var d=c.Promise.when(e.map(a,function(a){return a._allPreviousSaves||c.Promise.as()})),f=new c.Promise;c._arrayEach(a,function(a){a._allPreviousSaves=f});return d._continueWith(function(){return c._request("batch",null,null,"POST",{requests:e.map(a,function(a){var b=a._getSaveJSON(),c="POST",d="/1/classes/"+a.className;a.id&&(d=d+"/"+a.id,c="PUT");a._startSave();return{method:c,path:d,body:b}})}).then(function(b,d,e){var f;c._arrayEach(a,function(a,c){b[c].success?a._finishSave(a.parse(b[c].success,d,e)):(f=f||b[c].error,a._cancelSave())});if(f)return c.Promise.error(new c.Error(f.code,f.error))}).then(function(a){f.resolve(a);return a},function(a){f.reject(a);return c.Promise.error(a)})})})}).then(function(){return a})};c.Role=c.Object.extend("_Role",{constructor:function(a,b){e.isString(a)&&b instanceof c.ACL?(c.Object.prototype.constructor.call(this,null,null),this.setName(a),this.setACL(b)):c.Object.prototype.constructor.call(this,a,b)},getName:function(){return this.get("name")},setName:function(a,b){return this.set("name",a,b)},getUsers:function(){return this.relation("users")},getRoles:function(){return this.relation("roles")},validate:function(a,b){if("name"in a&&a.name!==this.getName()){var d=a.name;if(this.id&&this.id!==a.objectId)return new c.Error(c.Error.OTHER_CAUSE,"A role's name can only be set before it has been saved.");if(!e.isString(d))return new c.Error(c.Error.OTHER_CAUSE,"A role's name must be a String.");if(!/^[0-9a-zA-Z\-_ ]+$/.test(d))return new c.Error(c.Error.OTHER_CAUSE,"A role's name can only contain alphanumeric characters, _, -, and spaces.")}return c.Object.prototype.validate?c.Object.prototype.validate.call(this,a,b):!1}});c.Collection=function(a,b){b=b||{};b.comparator&&(this.comparator=b.comparator);b.model&&(this.model=b.model);b.query&&(this.query=b.query);this._reset();this.initialize.apply(this,arguments);a&&this.reset(a,{silent:!0,parse:b.parse})};e.extend(c.Collection.prototype,c.Events,{model:c.Object,initialize:function(){},toJSON:function(){return this.map(function(a){return a.toJSON()})},add:function(a,b){var d,f,g,h,k,l={},m={};b=b||{};a=e.isArray(a)?a.slice():[a];d=0;for(f=a.length;d<f;d++){a[d]=this._prepareModel(a[d],b);g=a[d];if(!g)throw Error("Can't add an invalid model to a collection");h=g.cid;if(l[h]||this._byCid[h])throw Error("Duplicate cid: can't add the same model to a collection twice");k=g.id;if(!c._isNullOrUndefined(k)&&(m[k]||this._byId[k]))throw Error("Duplicate id: can't add the same model to a collection twice");m[k]=g;l[h]=g}for(d=0;d<f;d++)(g=a[d]).on("all",this._onModelEvent,this),this._byCid[g.cid]=g,g.id&&(this._byId[g.id]=g);this.length+=f;d=c._isNullOrUndefined(b.at)?this.models.length:b.at;this.models.splice.apply(this.models,[d,0].concat(a));this.comparator&&this.sort({silent:!0});if(b.silent)return this;d=0;for(f=this.models.length;d<f;d++)g=this.models[d],l[g.cid]&&(b.index=d,g.trigger("add",g,this,b));return this},remove:function(a,b){var c,f,g,h;b=b||{};a=e.isArray(a)?a.slice():[a];c=0;for(f=a.length;c<f;c++)if(h=this.getByCid(a[c])||this.get(a[c]))delete this._byId[h.id],delete this._byCid[h.cid],g=this.indexOf(h),this.models.splice(g,1),this.length--,b.silent||(b.index=g,h.trigger("remove",h,this,b)),this._removeReference(h);return this},get:function(a){return a&&this._byId[a.id||a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},sort:function(a){a=a||{};if(!this.comparator)throw Error("Cannot sort a set without a comparator");var b=e.bind(this.comparator,this);1===this.comparator.length?this.models=this.sortBy(b):this.models.sort(b);a.silent||this.trigger("reset",this,a);return this},pluck:function(a){return e.map(this.models,function(b){return b.get(a)})},reset:function(a,b){var d=this;a=a||[];b=b||{};c._arrayEach(this.models,function(a){d._removeReference(a)});this._reset();this.add(a,{silent:!0,parse:b.parse});b.silent||this.trigger("reset",this,b);return this},fetch:function(a){a=e.clone(a)||{};void 0===a.parse&&(a.parse=!0);var b=this;return(this.query||new c.Query(this.model)).find().then(function(c){a.add?b.add(c,a):b.reset(c,a);return b})._thenRunCallbacks(a,this)},create:function(a,b){var c=this;b=b?e.clone(b):{};a=this._prepareModel(a,b);if(!a)return!1;b.wait||c.add(a,b);var f=b.success;b.success=function(d,e,k){b.wait&&c.add(d,b);f?f(d,e):d.trigger("sync",a,e,b)};a.save(null,b);return a},parse:function(a,b){return a},chain:function(){return e(this.models).chain()},_reset:function(a){this.length=0;this.models=[];this._byId={};this._byCid={}},_prepareModel:function(a,b){a instanceof c.Object?a.collection||(a.collection=this):(b.collection=this,a=new this.model(a,b),a._validate(a.attributes,b)||(a=!1));return a},_removeReference:function(a){this===a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,b,c,e){if("add"!==a&&"remove"!==a||c===this)"destroy"===a&&this.remove(b,e),b&&"change:objectId"===a&&(delete this._byId[b.previous("objectId")],this._byId[b.id]=b),this.trigger.apply(this,arguments)}});c._arrayEach("forEach each map reduce reduceRight find detect filter select reject every all some any include contains invoke max min sortBy sortedIndex toArray size first initial rest last without indexOf shuffle lastIndexOf isEmpty groupBy".split(" "),function(a){c.Collection.prototype[a]=function(){return e[a].apply(e,[this.models].concat(e.toArray(arguments)))}});c.Collection.extend=c._extend;c.View=function(a){this.cid=e.uniqueId("view");this._configure(a||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var n=/^(\S+)\s*(.*)$/,w="model collection el id attributes className tagName".split(" ");e.extend(c.View.prototype,c.Events,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();return this},make:function(a,b,d){a=document.createElement(a);b&&c.$(a).attr(b);d&&c.$(a).html(d);return a},setElement:function(a,b){this.$el=c.$(a);this.el=this.$el[0];!1!==b&&this.delegateEvents();return this},delegateEvents:function(a){if(a=a||c._getValue(this,"events")){this.undelegateEvents();var b=this;c._objectEach(a,function(c,f){e.isFunction(c)||(c=b[a[f]]);if(!c)throw Error('Event "'+a[f]+'" does not exist');var d=f.match(n),h=d[1],d=d[2];c=e.bind(c,b);h+=".delegateEvents"+b.cid;""===d?b.$el.bind(h,c):b.$el.delegate(d,h,c)})}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(a){this.options&&(a=e.extend({},this.options,a));var b=this;e.each(w,function(c){a[c]&&(b[c]=a[c])});this.options=a},_ensureElement:function(){if(this.el)this.setElement(this.el,!1);else{var a=c._getValue(this,"attributes")||{};this.id&&(a.id=this.id);this.className&&(a["class"]=this.className);this.setElement(this.make(this.tagName,a),!1)}}});c.View.extend=c._extend;c.User=c.Object.extend("_User",{_isCurrentUser:!1,_mergeMagicFields:function(a){a.sessionToken&&(this._sessionToken=a.sessionToken,delete a.sessionToken);c.User.__super__._mergeMagicFields.call(this,a)},_cleanupAuthData:function(){if(this.isCurrent()){var a=this.get("authData");a&&c._objectEach(this.get("authData"),function(b,c){a[c]||delete a[c]})}},_synchronizeAllAuthData:function(){if(this.get("authData")){var a=this;c._objectEach(this.get("authData"),function(b,c){a._synchronizeAuthData(c)})}},_synchronizeAuthData:function(a){if(this.isCurrent()){var b;e.isString(a)?(b=a,a=c.User._authProviders[b]):b=a.getAuthType();var d=this.get("authData");d&&a&&(a.restoreAuthentication(d[b])||this._unlinkFrom(a))}},_handleSaveResult:function(a){a&&(this._isCurrentUser=!0);this._cleanupAuthData();this._synchronizeAllAuthData();delete this._serverData.password;this._rebuildEstimatedDataForKey("password");this._refreshCache();(a||this.isCurrent())&&c.User._saveCurrentUser(this)},_linkWith:function(a,b){var d=this,f;e.isString(a)?(f=a,a=c.User._authProviders[a]):f=a.getAuthType();if(b){var g=this.get("authData")||{};g[f]=b;this.set("authData",g);var h=new c.Promise;this.save({authData:g},void 0).then(function(a){a._handleSaveResult(!0);h.resolve(a)});return h._thenRunCallbacks({})}return a.authenticate().then(function(b){return d._linkWith(a,b)})},loginWithWeapp:function(a){var b=new c.Promise;c.User.requestOpenId(a,{success:function(a){c.Object._create("_User")._linkWith("weapp",a).then(function(a){b.resolve(a)},function(a){b.reject(a)})},error:function(a){b.reject(a)}});return b._thenRunCallbacks({})},_unlinkFrom:function(a,b){e.isString(a)?a=c.User._authProviders[a]:a.getAuthType();var d=e.clone(b),f=this;d.authData=null;d.success=function(c){f._synchronizeAuthData(a);b.success&&b.success.apply(this,arguments)};return this._linkWith(a,d)},_isLinked:function(a){a=e.isString(a)?a:a.getAuthType();return!!(this.get("authData")||{})[a]},_logOutWithAll:function(){if(this.get("authData")){var a=this;c._objectEach(this.get("authData"),function(b,c){a._logOutWith(c)})}},_logOutWith:function(a){this.isCurrent()&&(e.isString(a)&&(a=c.User._authProviders[a]),a&&a.deauthenticate&&a.deauthenticate())},signUp:function(a,b){var d;b=b||{};d=a&&a.username||this.get("username");if(!d||""===d)return d=new c.Error(c.Error.OTHER_CAUSE,"Cannot sign up user with an empty name."),b&&b.error&&b.error(this,d),c.Promise.error(d);d=a&&a.password||this.get("password");if(!d||""===d)return d=new c.Error(c.Error.OTHER_CAUSE,"Cannot sign up user with an empty password."),b&&b.error&&b.error(this,d),c.Promise.error(d);d=e.clone(b);d.success=function(a){a._handleSaveResult(!0);b.success&&b.success.apply(this,arguments)};return this.save(a,d)},logIn:function(a){var b=this;return c._request("login",null,null,"GET",this.toJSON()).then(function(a,c,e){a=b.parse(a,c,e);b._finishFetch(a);b._handleSaveResult(!0);return b})._thenRunCallbacks(a,this)},save:function(a,b,d){var f,g;e.isObject(a)||e.isNull(a)||e.isUndefined(a)?(f=a,g=b):(f={},f[a]=b,g=d);g=g||{};a=e.clone(g);a.success=function(a){a._handleSaveResult(!1);g.success&&g.success.apply(this,arguments)};return c.Object.prototype.save.call(this,f,a)},fetch:function(a){var b=a?e.clone(a):{};b.success=function(b){b._handleSaveResult(!1);a&&a.success&&a.success.apply(this,arguments)};return c.Object.prototype.fetch.call(this,b)},isCurrent:function(){return this._isCurrentUser},getUsername:function(){return this.get("username")},setUsername:function(a,b){return this.set("username",a,b)},setPassword:function(a,b){return this.set("password",a,b)},getEmail:function(){return this.get("email")},setEmail:function(a,b){return this.set("email",a,b)},authenticated:function(){return!!this._sessionToken&&c.User.current()&&c.User.current().id===this.id}},{_currentUser:null,_currentUserMatchesDisk:!1,_CURRENT_USER_KEY:"currentUser",_authProviders:{},signUp:function(a,b,d,e){d=d||{};d.username=a;d.password=b;return c.Object._create("_User").signUp(d,e)},logIn:function(a,b,d){var e=c.Object._create("_User");e._finishFetch({username:a,password:b});return e.logIn(d)},logOut:function(){null!==c.User._currentUser&&(c.User._currentUser._logOutWithAll(),c.User._currentUser._isCurrentUser=!1);c.User._currentUserMatchesDisk=!0;c.User._currentUser=null;wx.removeStorage({key:c._getBmobPath(c.User._CURRENT_USER_KEY),success:function(a){console.log(a.data)}})},requestPasswordReset:function(a,b){return c._request("requestPasswordReset",null,null,"POST",{email:a})._thenRunCallbacks(b)},requestEmailVerify:function(a,b){return c._request("requestEmailVerify",null,null,"POST",{email:a})._thenRunCallbacks(b)},requestOpenId:function(a,b){return c._request("wechatApp",a,null,"POST",{code:a})._thenRunCallbacks(b)},current:function(){if(c.User._currentUser||c.User._currentUserMatchesDisk)return c.User._currentUser;c.User._currentUserMatchesDisk=!0;var a=!1;try{if(a=wx.getStorageSync(c._getBmobPath(c.User._CURRENT_USER_KEY))){c.User._currentUser=c.Object._create("_User");c.User._currentUser._isCurrentUser=!0;var b=JSON.parse(a);c.User._currentUser.id=b._id;delete b._id;c.User._currentUser._sessionToken=b._sessionToken;delete b._sessionToken;c.User._currentUser.set(b);c.User._currentUser._synchronizeAllAuthData();c.User._currentUser._refreshCache();c.User._currentUser._opSetQueue=[{}];return c.User._currentUser}}catch(d){return null}},_saveCurrentUser:function(a){c.User._currentUser!==a&&c.User.logOut();a._isCurrentUser=!0;c.User._currentUser=a;c.User._currentUserMatchesDisk=!0;var b=a.toJSON();b._id=a.id;b._sessionToken=a._sessionToken;wx.setStorage({key:c._getBmobPath(c.User._CURRENT_USER_KEY),data:JSON.stringify(b)})},_registerAuthenticationProvider:function(a){c.User._authProviders[a.getAuthType()]=a;c.User.current()&&c.User.current()._synchronizeAuthData(a.getAuthType())},_logInWith:function(a,b){return c.Object._create("_User")._linkWith(a,b)}});c.Query=function(a){e.isString(a)&&(a=c.Object._getSubclass(a));this.objectClass=a;this.className=a.prototype.className;this._where={};this._include=[];this._limit=-1;this._skip=0;this._extraOptions={}};c.Query.or=function(){var a=e.toArray(arguments),b=null;c._arrayEach(a,function(a){e.isNull(b)&&(b=a.className);if(b!==a.className)throw"All queries must be for the same class";});var d=new c.Query(b);d._orQuery(a);return d};c.Query._extend=c._extend;c.Query.prototype={_processResult:function(a){return a},get:function(a,b){this.equalTo("objectId",a);return this.first().then(function(a){if(a)return a;a=new c.Error(c.Error.OBJECT_NOT_FOUND,"Object not found.");return c.Promise.error(a)})._thenRunCallbacks(b,null)},toJSON:function(){var a={where:this._where};0<this._include.length&&(a.include=this._include.join(","));this._select&&(a.keys=this._select.join(","));0<=this._limit&&(a.limit=this._limit);0<this._skip&&(a.skip=this._skip);void 0!==this._order&&(a.order=this._order);c._objectEach(this._extraOptions,function(b,c){a[c]=b});return a},_newObject:function(a){if("undefined"===typeof b)var b;return b=a&&a.className?new c.Object(a.className):new this.objectClass},_createRequest:function(a){return c._request("classes",this.className,null,"GET",a||this.toJSON())},find:function(a){var b=this;return this._createRequest().then(function(a){return e.map(a.results,function(c){var d=b._newObject(a);d._finishFetch(b._processResult(c),!0);return d})})._thenRunCallbacks(a)},destroyAll:function(a){return this.find().then(function(a){return c.Object.destroyAll(a)})._thenRunCallbacks(a)},count:function(a){var b=this.toJSON();b.limit=0;b.count=1;return this._createRequest(b).then(function(a){return a.count})._thenRunCallbacks(a)},first:function(a){var b=this,c=this.toJSON();c.limit=1;return this._createRequest(c).then(function(a){return e.map(a.results,function(a){var c=b._newObject();c._finishFetch(b._processResult(a),!0);return c})[0]})._thenRunCallbacks(a)},collection:function(a,b){b=b||{};return new c.Collection(a,e.extend(b,{model:this._objectClass||this.objectClass,query:this}))},skip:function(a){this._skip=a;return this},limit:function(a){this._limit=a;return this},equalTo:function(a,b){this._where[a]=c._encode(b);return this},_addCondition:function(a,b,d){this._where[a]||(this._where[a]={});this._where[a][b]=c._encode(d);return this},notEqualTo:function(a,b){this._addCondition(a,"$ne",b);return this},lessThan:function(a,b){this._addCondition(a,"$lt",b);return this},greaterThan:function(a,b){this._addCondition(a,"$gt",b);return this},lessThanOrEqualTo:function(a,b){this._addCondition(a,"$lte",b);return this},greaterThanOrEqualTo:function(a,b){this._addCondition(a,"$gte",b);return this},containedIn:function(a,b){this._addCondition(a,"$in",b);return this},notContainedIn:function(a,b){this._addCondition(a,"$nin",b);return this},containsAll:function(a,b){this._addCondition(a,"$all",b);return this},exists:function(a){this._addCondition(a,"$exists",!0);return this},doesNotExist:function(a){this._addCondition(a,"$exists",!1);return this},matches:function(a,b,c){this._addCondition(a,"$regex",b);c||(c="");b.ignoreCase&&(c+="i");b.multiline&&(c+="m");c&&c.length&&this._addCondition(a,"$options",c);return this},matchesQuery:function(a,b){var c=b.toJSON();c.className=b.className;this._addCondition(a,"$inQuery",c);return this},doesNotMatchQuery:function(a,b){var c=b.toJSON();c.className=b.className;this._addCondition(a,"$notInQuery",c);return this},matchesKeyInQuery:function(a,b,c){var d=c.toJSON();d.className=c.className;this._addCondition(a,"$select",{key:b,query:d});return this},doesNotMatchKeyInQuery:function(a,b,c){var d=c.toJSON();d.className=c.className;this._addCondition(a,"$dontSelect",{key:b,query:d});return this},_orQuery:function(a){a=e.map(a,function(a){return a.toJSON().where});this._where.$or=a;return this},_quote:function(a){return"\\Q"+a.replace("\\E","\\E\\\\E\\Q")+"\\E"},contains:function(a,b){this._addCondition(a,"$regex",this._quote(b));return this},startsWith:function(a,b){this._addCondition(a,"$regex","^"+this._quote(b));return this},endsWith:function(a,b){this._addCondition(a,"$regex",this._quote(b)+"$");return this},ascending:function(a){c._isNullOrUndefined(this._order)?this._order=a:this._order=this._order+","+a;return this},cleanOrder:function(a){this._order=null;return this},descending:function(a){c._isNullOrUndefined(this._order)?this._order="-"+a:this._order=this._order+",-"+a;return this},near:function(a,b){b instanceof c.GeoPoint||(b=new c.GeoPoint(b));this._addCondition(a,"$nearSphere",b);return this},withinRadians:function(a,b,c){this.near(a,b);this._addCondition(a,"$maxDistance",c);return this},withinMiles:function(a,b,c){return this.withinRadians(a,b,c/3958.8)},withinKilometers:function(a,b,c){return this.withinRadians(a,b,c/6371)},withinGeoBox:function(a,b,d){b instanceof c.GeoPoint||(b=new c.GeoPoint(b));d instanceof c.GeoPoint||(d=new c.GeoPoint(d));this._addCondition(a,"$within",{$box:[b,d]});return this},include:function(){var a=this;c._arrayEach(arguments,function(b){e.isArray(b)?a._include=a._include.concat(b):a._include.push(b)});return this},select:function(){var a=this;this._select=this._select||[];c._arrayEach(arguments,function(b){e.isArray(b)?a._select=a._select.concat(b):a._select.push(b)});return this},each:function(a,b){b=b||{};if(this._order||this._skip||0<=this._limit)return c.Promise.error("Cannot iterate on a query with sort, skip, or limit.")._thenRunCallbacks(b);new c.Promise;var d=new c.Query(this.objectClass);d._limit=b.batchSize||100;d._where=e.clone(this._where);d._include=e.clone(this._include);d.ascending("objectId");var f=!1;return c.Promise._continueWhile(function(){return!f},function(){return d.find().then(function(b){var e=c.Promise.as();c._.each(b,function(b){e=e.then(function(){return a(b)})});return e.then(function(){b.length>=d._limit?d.greaterThan("objectId",b[b.length-1].id):f=!0})})})._thenRunCallbacks(b)}};c.FriendShipQuery=c.Query._extend({_objectClass:c.User,_newObject:function(){return new c.User},_processResult:function(a){a=a[this._friendshipTag];"Pointer"===a.__type&&"_User"===a.className&&(delete a.__type,delete a.className);return a}});c.History=function(){this.handlers=[];e.bindAll(this,"checkUrl")};var p=/^[#\/]/,x=/msie [\w.]+/;c.History.started=!1;e.extend(c.History.prototype,c.Events,{interval:50,getHash:function(a){return(a=(a?a.location:window.location).href.match(/#(.*)$/))?a[1]:""},getFragment:function(a,b){if(c._isNullOrUndefined(a))if(this._hasPushState||b){a=window.location.pathname;var d=window.location.search;d&&(a+=d)}else a=this.getHash();a.indexOf(this.options.root)||(a=a.substr(this.options.root.length));return a.replace(p,"")},start:function(a){if(c.History.started)throw Error("Bmob.history has already been started");c.History.started=!0;this.options=e.extend({},{root:"/"},this.options,a);this._wantsHashChange=!1!==this.options.hashChange;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);a=this.getFragment();var b=document.documentMode;if(b=x.exec(navigator.userAgent.toLowerCase())&&(!b||7>=b))this.iframe=c.$('\x3ciframe src\x3d"javascript:0" tabindex\x3d"-1" /\x3e').hide().appendTo("body")[0].contentWindow,this.navigate(a);this._hasPushState?c.$(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!b?c.$(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=window.setInterval(this.checkUrl,this.interval));this.fragment=a;a=window.location;b=a.pathname===this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!b)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0;this._wantsPushState&&this._hasPushState&&b&&a.hash&&(this.fragment=this.getHash().replace(p,""),window.history.replaceState({},document.title,a.protocol+"//"+a.host+this.options.root+this.fragment));if(!this.options.silent)return this.loadUrl()},stop:function(){c.$(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl);window.clearInterval(this._checkUrlInterval);c.History.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(a){a=this.getFragment();a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe)));if(a===this.fragment)return!1;this.iframe&&this.navigate(a);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(a){var b=this.fragment=this.getFragment(a);return e.any(this.handlers,function(a){if(a.route.test(b))return a.callback(b),!0})},navigate:function(a,b){if(!c.History.started)return!1;b&&!0!==b||(b={trigger:b});var d=(a||"").replace(p,"");this.fragment!==d&&(this._hasPushState?(0!==d.indexOf(this.options.root)&&(d=this.options.root+d),this.fragment=d,window.history[b.replace?"replaceState":"pushState"]({},document.title,d)):this._wantsHashChange?(this.fragment=d,this._updateHash(window.location,d,b.replace),this.iframe&&d!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,d,b.replace))):window.location.assign(this.options.root+a),b.trigger&&this.loadUrl(a))},_updateHash:function(a,b,c){c?(c=a.toString().replace(/(javascript:|#).*$/,""),a.replace(c+"#"+b)):a.hash=b}});c.Router=function(a){a=a||{};a.routes&&(this.routes=a.routes);this._bindRoutes();this.initialize.apply(this,arguments)};var y=/:\w+/g,z=/\*\w+/g,A=/[\-\[\]{}()+?.,\\\^\$\|#\s]/g;e.extend(c.Router.prototype,c.Events,{initialize:function(){},route:function(a,b,d){c.history=c.history||new c.History;e.isRegExp(a)||(a=this._routeToRegExp(a));d||(d=this[b]);c.history.route(a,e.bind(function(e){e=this._extractParameters(a,e);d&&d.apply(this,e);this.trigger.apply(this,["route:"+b].concat(e));c.history.trigger("route",this,b,e)},this));return this},navigate:function(a,b){c.history.navigate(a,b)},_bindRoutes:function(){if(this.routes){var a=[],b;for(b in this.routes)this.routes.hasOwnProperty(b)&&a.unshift([b,this.routes[b]]);b=0;for(var c=a.length;b<c;b++)this.route(a[b][0],a[b][1],this[a[b][1]])}},_routeToRegExp:function(a){a=a.replace(A,"\\$\x26").replace(y,"([^/]+)").replace(z,"(.*?)");return new RegExp("^"+a+"$")},_extractParameters:function(a,b){return a.exec(b).slice(1)}});c.Router.extend=c._extend;c.Image=c.Image||{};e.extend(c.Image,{thumbnail:function(a,b){return c._request("images/thumbnail",null,null,"POST",c._encode(a,null,!0)).then(function(a){return a})},watermark:function(a,b){return c._request("images/watermark",null,null,"POST",c._encode(a,null,!0)).then(function(a){return a})}});c.generateCode=c.generateCode||{};c.generateCode=function(a,b){return c._request("wechatApp/qr/generatecode",null,null,"POST",c._encode(a,null,!0)).then(function(a){return c._decode(null,a)})._thenRunCallbacks(b)};c.Sms=c.Sms||{};e.extend(c.Sms,{requestSms:function(a,b){return c._request("requestSms",null,null,"POST",c._encode(a,null,!0)).then(function(a){return c._decode(null,a)})._thenRunCallbacks(b)},requestSmsCode:function(a,b){return c._request("requestSmsCode",null,null,"POST",c._encode(a,null,!0)).then(function(a){return c._decode(null,a)})._thenRunCallbacks(b)},verifySmsCode:function(a,b,d){return c._request("verifySmsCode/"+b,null,null,"POST",c._encode({mobilePhoneNumber:a},null,!0)).then(function(a){return c._decode(null,a)})._thenRunCallbacks(d)},querySms:function(a,b){return c._request("querySms/"+a,null,null,"GET",null).then(function(a){return c._decode(null,a)})._thenRunCallbacks(b)}});c.Pay=c.Pay||{};e.extend(c.Pay,{wechatPay:function(a,b,d,e,g){return c._request("pay",null,null,"POST",c._encode({order_price:a,product_name:b,body:d,open_id:e,pay_type:4},null,!0)).then(function(a){return c._decode(null,a)})._thenRunCallbacks(g)},queryOrder:function(a,b){return c._request("pay/"+a,null,null,"GET",null).then(function(a){return c._decode(null,a)})._thenRunCallbacks(b)}});c.Cloud=c.Cloud||{};e.extend(c.Cloud,{run:function(a,b,d){return c._request("functions",a,null,"POST",c._encode(b,null,!0)).then(function(a){return c._decode(null,a).result})._thenRunCallbacks(d)}});c.Installation=c.Object.extend("_Installation");c.Push=c.Push||{};c.Push.send=function(a,b){a.where&&(a.where=a.where.toJSON().where);a.push_time&&(a.push_time=a.push_time.toJSON());a.expiration_time&&(a.expiration_time=a.expiration_time.toJSON());if(a.expiration_time&&a.expiration_time_interval)throw"Both expiration_time and expiration_time_interval can't be set";return c._request("push",null,null,"POST",a)._thenRunCallbacks(b)}}).call(this);